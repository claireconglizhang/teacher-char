---
title: "teacher characteristics"
output: html_document
date: '2022-09-28'
---
hello

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      message = FALSE)
pacman::p_load(tidyverse, janitor, rio, here, gtsummary, modelsummary, stargazer, huxtable, lfe, lubridate, psych)
```


```{r, functions}
percentage <- function(x){
  paste(round(100*x, 2), "%", sep="")
}

round3 <- function(x){
  paste(round(x, digits = 3))
}

nmlz <- function(x){
  x = (x-mean(x, na.rm = TRUE))/sd(x, na.rm = TRUE)
  x
}

na_percentage <- function(x){
  y = sum(is.na(x))/length(x)
  paste(round(100*y, 2), "%", sep="")
}

mymean = function(x){
  x = combn(rev(x), n()-1, FUN = mean, na.rm = TRUE)
  x
}
```

### Note that this analytic sample is using all CEPS schools (N=112)

```{r}
schid_full <- rio::import(here::here("data", "schid_full.csv"))
schid_random <- rio::import(here::here("data", "schid_random.csv"))
schid_nosorting <- rio::import(here::here("data", "schid_nosorting.csv"))
schid_nochange <- rio::import(here::here("data", "schid_nochange.csv"))
schid_nochange_2cls <- rio::import(here::here("data", "schid_nochange_2cls.csv"))

full_sch_1 <- rio::import(here::here("data", "cepsw1principalEN.dta")) 
full_tch_1 <- rio::import(here::here("data", "cepsw1teacherEN.dta")) 
full_stu_1 <- rio::import(here::here("data", "cepsw1studentEN.dta")) 
full_prt_1 <- rio::import(here::here("data", "cepsw1parentEN.dta")) 
```

### TBCs of interest 

 - Educational background 
   - years of education (tchedu)
   - graduate degree - master's and above (tchgrad)
 - Teaching experience
   - years of teaching (tchexp)
   - novice teacher (tchnew)
 - Teacher gender
   - teacher gender (tchfemale)
   - teacher-student gender match 

#### Outcomes of interest

 - Student academic performance (score)
 - Student academic confidence (conf)
 
#### Missingness

Missing on teacher characteristics:

```{r}
# The most painful structure of baseline teacher data is that it's in wide format. 
# take tchfemale as an example, it is not one variable, it is four variables, hrc01 for teacher-advisor (TA), chnb01 for chinese teacher, engb01 for english teacher, and matb01 for math teacher. 
# one messed up thing is, if the TA teaches Chinese, chnb01 will be coded missing

tch_ta <- full_tch_1 %>% 
  filter(hra01 %in% c(1,2,3)) %>% #hra01, the subject the TA teaches, 1=mat, 2=chn, 3=eng, 0=other
  select(schids,
         clsids,
         tchfemale_ta = hrc01,
         tchexp_ta = hrc07,
         tchedu_ta = hrc04,
         subject = hra01) %>% 
  complete(clsids, subject)

tch_chn <- full_tch_1 %>% 
  select(schids,
         clsids,
         tchfemale3 = chnb01,
         tchexp3 = chnb07,
         tchedu3 = chnb04) %>% 
  mutate(subject = 2)

tch_eng <- full_tch_1 %>% 
  select(schids,
         clsids,
         tchfemale3 = engb01,
         tchexp3 = engb07,
         tchedu3 = engb04) %>% 
  mutate(subject = 3)

tch_mat <- full_tch_1 %>% 
  select(schids,
         clsids,
         tchfemale3 = matb01,
         tchexp3 = matb07,
         tchedu3 = matb04) %>% 
  mutate(subject = 1)

tch_subject <- rbind(tch_chn, tch_eng, tch_mat) 

tch_char <- full_join(tch_ta, tch_subject) %>% 
  ungroup() %>% 
  mutate(tchfemale = coalesce(tchfemale_ta, tchfemale3),
         tchexp = coalesce(tchexp_ta, tchexp3),
         tchedu = coalesce(tchedu_ta, tchedu3)) %>% 
  drop_na(schids, clsids) %>% 
  mutate(tchfemale = recode(tchfemale, '2' = 1, '1' = 0),
         tchedu = recode(tchedu, '1' = 9, '2' = 12, '3' = 12, '4' = 14, '5' = 16, '6' = 16, '7' = 19),
         tchgrad = ifelse(tchedu >= 19, 1, 0),
         tchnew = ifelse(tchexp <= 3, 1, 0))  %>% 
  ungroup() %>% 
  select(schids, clsids, subject, tchedu, tchgrad, tchexp, tchnew, tchfemale)

apply(tch_char, 2, na_percentage)
```

Missing on student academic performance and confidence:

```{r}
stu_chn <- full_stu_1 %>% 
  select(ids, schids, clsids,
         score = stdchn, # CEPS within school standardized score/mean = 70, sd = 10
         conf = c1102) %>% # confidence in learning chinese (c1103, english; c1101, math)
  mutate(score = (score-70)/10) %>% 
  group_by(schids) %>% 
  mutate(conf = nmlz(conf)) %>% 
  ungroup() %>% 
  mutate(subject = 2)

stu_eng <- full_stu_1 %>% 
  select(ids, schids, clsids,
         score = stdeng, 
         conf = c1103) %>% 
  mutate(score = (score-70)/10) %>% 
  group_by(schids) %>% 
  mutate(conf = nmlz(conf)) %>% 
  ungroup() %>% 
  mutate(subject = 3)

stu_mat <- full_stu_1 %>% 
  select(ids, schids, clsids,
         score = stdmat, 
         conf = c1101) %>%
  mutate(score = (score-70)/10) %>% 
  group_by(schids) %>% 
  mutate(conf = nmlz(conf)) %>% 
  ungroup() %>%  
  mutate(subject = 1)

stu_aca <- rbind(stu_chn, stu_eng, stu_mat)

apply(stu_aca, 2, na_percentage)
```

Missing on student characteristics:

```{r}
stu_char <- full_stu_1 %>% 
  select(ids, schids, clsids, grade9, fall,
         cog = cog3pl, # CEPS full sample standardized score/mean = 0, sd = 1
         female = stsex,
         birthyear= a02a, # 405 is missing
         birthmonth = a02b,
         only = stonly,
         rural = sthktype, 
         migrant = stmigrant, 
         medu = stmedu, 
         fedu = stfedu,
         income = steco_3c) %>% 
  mutate(birthyear = ifelse(birthyear == 2020, 2002, birthyear),
         birthmonth = ifelse(is.na(birthmonth), 1, birthmonth)) %>%
  mutate(birth = ym(paste(birthyear, birthmonth, sep = "-")),
         entry = ym("2013-9"),
         age = floor(decimal_date(entry) - decimal_date(birth)), 
         female = recode(female, '1' = 0, '0' = 1),
         only = recode(only,'1' = 1, '2' = 0),
         migrant = recode(migrant,'1' = 0, '2' = 1, '3' = 1),
         medu = recode(medu, '1' = 0, '2' = 6, '3' = 9, '4' = 12, '5' = 12, '6' = 12, '7' = 14, '8' = 16, '9' = 19),
         fedu = recode(fedu, '1' = 0, '2' = 6, '3' = 9, '4' = 12, '5' = 12, '6' = 12, '7' = 14, '8' = 16, '9' = 19),
         income = recode(income, '1' = 0, '2' = 1, '3' = 2)) %>% 
  group_by(clsids) %>% 
  mutate(hrsize = n(),
         hrfemale = mymean(female),
         hrage = mymean(age),
         hronly = mymean(only),
         hrrural = mymean(rural),
         hrmigrant = mymean(migrant),
         hrmedu = mymean(medu),
         hrfedu = mymean(fedu),
         hrincome = mymean(income)) %>% 
  ungroup() %>% 
  select(-birthyear, -birthmonth, -entry, -birth)

apply(stu_char, 2, na_percentage)
```


Missing after match teacher and student data

```{r}
char0 <- left_join(full_join(stu_aca, stu_char), tch_char) %>% 
  ungroup() %>% 
  mutate(match = ifelse(female == tchfemale, 1, 0))

apply(char0, 2, na_percentage)

char <- char0 %>% 
  drop_na()
```

#### Descriptive stats

Table 1. Descriptive statistics of key variables

```{r}
char %>% 
  select(tchedu, tchgrad, tchexp, tchnew, tchfemale, female, match, score, conf) %>% 
  tbl_summary(
    type = list(c("tchedu", "tchexp", "score", "conf") ~ "continuous",
                c("tchgrad", "tchnew", "tchfemale", "match", "female") ~ "dichotomous"),
    statistic = list(all_continuous() ~ "{mean} ({min}, {max})",
                     all_categorical() ~ "{n} / {N} ({p}%)"),
    label = list(tchedu ~ "Teacher education (years)",
                 tchgrad ~ "Graduate degree",
                 tchexp ~ "Teacher experience (years)",
                 tchnew ~ "Novice teacher (less than 3Y)",
                 tchfemale ~ "Female teacher",
                 match ~ "Teacher-student gender match",
                 female ~ "Female student",
                 score ~ "Student academic performance",
                 conf ~ "Student academic confidence")
  )
```

#### Covariates balance

```{r, include = TRUE, results = "asis"}
add_f <- function(model){
  f <- summary(model)$P.fstat
  star <- case_when(
    f[4] >= 0.05 ~ "",
    f[4]<0.05 & f[4]>=0.01 ~ "*",
    f[4]<0.01 & f[4]>=0.001 ~ "**",
    f[4] < 0.001 ~ "***")
  paste(round(f[5], 3), star, " (df = ", f[3], "; ", f[6], ")", sep = "")
}  

random <- function(var){
  felm(var ~ cog + female + age + only + rural + migrant + medu + fedu + income | schids + grade9 + subject | 0 | clsids, char)
}

labels <- c("Cognitive Score",
            "Female student",
            "Age",
            "Only child",
            "Rural residency",
            "Migrant worker family",
            "Mother education (years)",
            "Father education (years)",
            "Family income")

c1 <- random(char$tchedu)
c2 <- random(char$tchgrad)
c3 <- random(char$tchexp)
c4 <- random(char$tchnew)
c5 <- random(char$tchfemale)
c6 <- random(char$match)
c7 <- random(char$score)
c8 <- random(char$conf)


stargazer(c1, c2, c3, c4, c5, c6, c7, c8,
          type = "html",
          omit = c("Constant"),
          dep.var.caption = "",
          dep.var.labels = "",
          covariate.labels = labels,
          model.numbers = FALSE,
          column.labels = c("Teacher education (years)", "Graduate degree", "Teacher experience (years)", "Novice teacher (less than 3Y)", "Female teacher", "Teacher-student gender match", "Student academic performance", "Student academic confidence"),
          star.cutoffs=c(0.05, 0.01, 0.001), 
          digits = 3, 
          flip = TRUE, 
          no.space = TRUE,
          notes.append=F, notes = c("*p$<$0.05, **p$<$0.01, ***p$<$0.001. Cells report coefficients and associated standard errors"),
          notes.align="l",
          add.lines = list(c("School FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Grade FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Subject FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Classroom clustered SE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("F-Statistics", add_f(c1), add_f(c2), add_f(c3), add_f(c4), add_f(c5), add_f(c6), add_f(c7), add_f(c8))))
```

#### Teacher educational background on student outcomes

```{r, include = TRUE, results = "asis"}
ols1 <- function(pred, out){
  felm(out ~ pred + poly(cog, 3) + female + age + only + rural + migrant + medu + fedu + income | schids + grade9 + subject | 0 | clsids, char)
}

ols2 <- function(pred, out){
  felm(out ~ pred + poly(cog, 3) + female + age + only + rural + migrant + medu + fedu + income + hrsize + hrfemale + hrage + hronly + hrrural + hrmigrant + hrmedu + hrfedu + hrincome | schids + grade9 + subject | 0 | clsids, char)
}

m1 <- ols1(char$tchedu, char$score)
m2 <- ols2(char$tchedu, char$score)

m3 <- ols1(char$tchgrad, char$score)
m4 <- ols2(char$tchgrad, char$score)

m5 <- ols1(char$tchedu, char$conf)
m6 <- ols2(char$tchedu, char$conf)

m7 <- ols1(char$tchgrad, char$conf)
m8 <- ols2(char$tchgrad, char$conf)

stargazer(m1, m2, m3, m4, m5, m6, m7, m8,
          type = "html",
          keep = c("\\bpred\\b"),
          model.numbers = FALSE,
          dep.var.caption = "",
          dep.var.labels = "",
          column.labels = c("Performance", "Performance", "Performance", "Performance", "Confidence", "Confidence", "Confidence", "Confidence"),
          star.cutoffs=c(0.05, 0.01, 0.001), 
          digits = 3, 
          flip = TRUE, 
          no.space = TRUE,
          notes.append=F, notes = c("*p$<$0.05, **p$<$0.01, ***p$<$0.001. Cells report coefficients and associated standard errors"),
          notes.align="l",
          add.lines = list(c("Student Covariates", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Homeroom Covariates", "No", "Yes", "No", "Yes", "No", "Yes", "No", "Yes"),
                           c("School FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Grade FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Subject FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Classroom clustered SE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes")))

```

#### Teacher experience on student outcomes

```{r, include = TRUE, results = "asis"}
ols1 <- function(pred, out){
  felm(out ~ pred + poly(cog, 3) + female + age + only + rural + migrant + medu + fedu + income | schids + grade9 + subject | 0 | clsids, char)
}

ols2 <- function(pred, out){
  felm(out ~ pred + poly(cog, 3) + female + age + only + rural + migrant + medu + fedu + income + hrsize + hrfemale + hrage + hronly + hrrural + hrmigrant + hrmedu + hrfedu + hrincome | schids + grade9 + subject | 0 | clsids, char)
}

m1 <- ols1(char$tchexp, char$score)
m2 <- ols2(char$tchexp, char$score)

m3 <- ols1(char$tchnew, char$score)
m4 <- ols2(char$tchnew, char$score)

m5 <- ols1(char$tchexp, char$conf)
m6 <- ols2(char$tchexp, char$conf)

m7 <- ols1(char$tchnew, char$conf)
m8 <- ols2(char$tchnew, char$conf)

stargazer(m1, m2, m3, m4, m5, m6, m7, m8,
          type = "html",
          keep = c("\\bpred\\b"),
          model.numbers = FALSE,
          dep.var.caption = "",
          dep.var.labels = "",
          column.labels = c("Performance", "Performance", "Performance", "Performance", "Confidence", "Confidence", "Confidence", "Confidence"),
          star.cutoffs=c(0.05, 0.01, 0.001), 
          digits = 3, 
          flip = TRUE, 
          no.space = TRUE,
          notes.append=F, notes = c("*p$<$0.05, **p$<$0.01, ***p$<$0.001. Cells report coefficients and associated standard errors"),
          notes.align="l",
          add.lines = list(c("Student Covariates", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Homeroom Covariates", "No", "Yes", "No", "Yes", "No", "Yes", "No", "Yes"),
                           c("School FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Grade FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Subject FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Classroom clustered SE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes")))

```


#### Teacher gender on student outcomes

```{r, include = TRUE, results = "asis"}
ols1 <- function(pred, out){
  felm(out ~ pred + poly(cog, 3) + female + age + only + rural + migrant + medu + fedu + income | schids + grade9 + subject | 0 | clsids, char)
}

ols2 <- function(pred, out){
  felm(out ~ pred + poly(cog, 3) + female + age + only + rural + migrant + medu + fedu + income + hrsize + hrfemale + hrage + hronly + hrrural + hrmigrant + hrmedu + hrfedu + hrincome | schids + grade9 + subject | 0 | clsids, char)
}

m1 <- ols1(char$tchfemale, char$score)
m2 <- ols2(char$tchfemale, char$score)

m3 <- ols1(char$match, char$score)
m4 <- ols2(char$match, char$score)

m5 <- ols1(char$tchfemale, char$conf)
m6 <- ols2(char$tchfemale, char$conf)

m7 <- ols1(char$match, char$conf)
m8 <- ols2(char$match, char$conf)

stargazer(m1, m2, m3, m4, m5, m6, m7, m8,
          type = "html",
          keep = c("\\bpred\\b"),
          model.numbers = FALSE,
          dep.var.caption = "",
          dep.var.labels = "",
          column.labels = c("Performance", "Performance", "Performance", "Performance", "Confidence", "Confidence", "Confidence", "Confidence"),
          star.cutoffs=c(0.05, 0.01, 0.001), 
          digits = 3, 
          flip = TRUE, 
          no.space = TRUE,
          notes.append=F, notes = c("*p$<$0.05, **p$<$0.01, ***p$<$0.001. Cells report coefficients and associated standard errors"),
          notes.align="l",
          add.lines = list(c("Student Covariates", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Homeroom Covariates", "No", "Yes", "No", "Yes", "No", "Yes", "No", "Yes"),
                           c("School FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Grade FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Subject FE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Classroom clustered SE", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes")))

```
